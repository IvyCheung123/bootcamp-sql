CREATE DATABASE BOOTCAMP_EXERCISE2;

USE BOOTCAMP_EXERCISE2;

CREATE TABLE WORKER (
WORKER_ID INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
FIRST_NAME CHAR(25),
LAST_NAME CHAR(25),
SALARY NUMERIC(15),
JOINING_DATE DATETIME,
DEPARTMENT CHAR(25)
);

INSERT INTO WORKER (FIRST_NAME, LAST_NAME, SALARY, JOINING_DATE, DEPARTMENT) VALUES 
('Monika', 'Arora', 100000, '21-02-20 09:00:00', 'HR'),
('Niharika', 'Verma', 80000, '21-06-11 09:00:00', 'Admin'),
('Vishal', 'Singhal', 300000, '21-02-20 09:00:00', 'HR'),
('Mohan', 'Sarah', 300000, '12-03-19 09:00:00', 'Admin'),
('Amitabh', 'Singh', 500000, '21-02-20 09:00:00', 'Admin'),
('Vivek', 'Bhati', 490000, '21-06-11 09:00:00', 'Admin'),
('Vipul', 'Diwan', 200000, '21-06-11 09:00:00', 'Account'),
('Satish', 'Kumar', 75000, '21-01-20 09:00:00', 'Account'),
('Geetika', 'Chauhan', 90000, '21-04-11 09:00:00', 'Admin');

CREATE TABLE BONUS (
WORKER_REF_ID INTEGER,
BONUS_AMOUNT NUMERIC(10),
BONUS_DATE DATETIME,
FOREIGN KEY (WORKER_REF_ID) REFERENCES WORKER(WORKER_ID)
);

-- Task 1
INSERT INTO BONUS VALUES 
(6, 32000, '21-11-02'),
(6, 20000, '22-11-02'),
(5, 21000, '21-11-02'),
(9, 30000, '21-11-02'),
(8, 4500, '22-11-02');

-- Task 2
SELECT W.SALARY AS SECOND_HIGHEST_SALARY
FROM WORKER W
ORDER BY W.SALARY DESC
LIMIT 1 OFFSET 1;

-- Task 3
SELECT CONCAT(W.FIRST_NAME, ' ', W.LAST_NAME) AS WORKER_NAME
FROM WORKER W
INNER JOIN (
SELECT DEPARTMENT, MAX(SALARY) AS MAX_SALARY
FROM WORKER
GROUP BY DEPARTMENT
) AS MS
ON W.DEPARTMENT = MS.DEPARTMENT
AND W.SALARY = MS.MAX_SALARY;

-- Task 4
SELECT W1.*
FROM WORKER W1
INNER JOIN WORKER W2
ON W1.SALARY = W2.SALARY
AND W1.WORKER_ID <> W2.WORKER_ID;

-- Task 5
SELECT CONCAT(W.FIRST_NAME, ' ', W.LAST_NAME) AS WORKER_NAME,
(W.SALARY + IFNULL(SUM(B.BONUS_AMOUNT), 0)) AS TOTAL_SALARY
FROM WORKER W
INNER JOIN BONUS B
ON W.WORKER_ID = B.WORKER_REF_ID
AND YEAR(B.BONUS_DATE) = 2021
GROUP BY W.WORKER_ID;

-- Task 6
DELETE FROM WORKER; -- Error Code: 1451. Cannot delete or update a parent row: a foreign key constraint fails (`bootcamp_exercise2`.`bonus`, CONSTRAINT `bonus_ibfk_1` FOREIGN KEY (`WORKER_REF_ID`) REFERENCES `worker` (`WORKER_ID`))

-- Task 7
DROP TABLE WORKER; -- Error Code: 3730. Cannot drop table 'worker' referenced by a foreign key constraint 'bonus_ibfk_1' on table 'BONUS'.

-- SET FOREIGN_KEY_CHECKS = 0;
-- SET FOREIGN_KEY_CHECKS = 1;